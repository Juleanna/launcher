# Руководство по созданию обновлений

Это руководство для сборки пакетов обновлений и публикации их на сервере обновлений. Подразумевается, что игроки используют лаунчер из этого репозитория.

## Термины и роли
- Signer (офлайн‑инструмент): модуль `crypto_signer.py`, используется только при сборке обновлений. Генерирует ключи, подписывает файлы, создаёт манифест.
- Verifier (клиент): модуль `crypto_verifier.py`, встроен в лаунчер. Проверяет подписи.

Приватный ключ храните только на машине сборки. Публичный ключ распространяется игрокам.

## Структура на сервере обновлений
Пример набора файлов на `https://updates.example.com/static/updates/`:
- `version.txt` — файл версий, содержит строку `LauncherVersion=1.0.2` и версии игры.
- `launcher_update.zip` — архив с обновлением лаунчера (опционально с манифестом).
- `files_list_v1.2.zip` — архив со списком/манифестом игровых файлов для версии 1.2.
- Дополнительно: `.manifest`/`.hash` в зависимости от схемы верификации.

Имена можно настраивать в `launcher_config.ini` ([Update] → `version_file`, `files_list_prefix`, `launcher_update_filename`).

## Подготовка окружения
- Зависимости: `pip install -r requirements.txt`
- Папка ключей: `crypto_keys/`
  - Публичный ключ: `public_key.pem`
  - Приватный ключ: `private_key.pem` (никогда не распространять)

Для генерации пары ключей (один раз):
```bash
python -c "from crypto_signer import Signer; s = Signer(); s.generate_keys()"
```

## Создание обновления игровых файлов
Запустите GUI‑утилиту генерации:
```bash
python Update.py
```
В окне:
1) Выберите директорию с актуальной сборкой игры
2) Укажите файл вывода списка/манифеста (например `files_list_v1.2.txt` — имя используется как основа для zip)
3) Введите версию (например `1.2`)
4) Отметьте “создавать подписи”, если вы публикуете манифест с подписями (рекомендовано)
5) Нажмите “Сгенерировать”

Что делает утилита:
- Формирует ZIP (`files_list_v<версия>.zip`) и текстовый список
- Если включена подпись — создаёт `files_list_v<версия>.zip.manifest` (и `.hash` при необходимости)
- Для `launcher_update.zip` — аналогично можно сформировать архив лаунчера и подписать/сгенерировать манифест

Загрузите получившиеся файлы в каталог `update_url` на сервере.

## Файл version.txt
Пример содержимого:
```
LauncherVersion=1.0.2
GameVersion=1.2
```
Лаунчер читает этот файл и принимает решение об обновлении лаунчера и игровых данных.

## Delta‑обновления (опционально)
Если используете `delta_updates.py` и `bsdiff4`, можно генерировать патчи “с версии A на версию B” и выкладывать `*_delta_A_to_B.zip`.
- Убедитесь, что в лаунчере включена логика определения выгоды применения дельты (функция `is_delta_update_beneficial`).
- При отсутствии или невыгодности дельты лаунчер скачает полный файл.

## Безопасность
- Приватный ключ храните только локально (офлайн/CI‑секрет). Никогда не выкладывайте его в репо или на сервер обновлений.
- Публичный ключ раздавайте по HTTPS. В `launcher_config.ini` укажите `public_key_url`.
- Для локальной разработки допустимо хранить `crypto_keys/public_key.pem` рядом с лаунчером.

## Публикация и CDN
- Рекомендуется раздавать обновления через HTTPS с поддержкой диапазонов (Accept‑Ranges: bytes) для докачки.
- Для крупных файлов используйте CDN; при этом `update_url` может указывать на CDN‑домен.

## Откат
- Сохраняйте предыдущие версии файлов (или используйте “backup_manager” на стороне клиента).
- Для отката обновите `version.txt` на предыдущую версию и верните соответствующие архивы.

## CI/CD
- Автоматизируйте сборку обновлений: шаги “собрать → подписать → опубликовать”.
- Проверяйте артефакты: форматы, подписи, корректность `version.txt`.

